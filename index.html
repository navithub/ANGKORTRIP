<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ûè·û∂·ûö·û∂·ûÑ·ûî·ûÑ·üí·ûö·üÄ·ûì</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles for Body */
        body {
            font-family: 'Battambang', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh; /* Allow scrolling */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to start for scrolling */
            transition: background-color 1s ease-in-out; 
        }

        /* --- 1. Rainbow Animated Background (ALL BG) --- */
        .rainbow-bg {
            background: linear-gradient(120deg, #ff0000, #ff8000, #ffff00, #00ff00, #00ffff, #0000ff, #9400d3, #ff0000);
            background-size: 500% 500%;
            animation: gradient-animation 25s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- 2. Creator Text Animation (Shimmering Glow) --- */
        @keyframes shimmer-glow {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #ff00ff; transform: translateY(0) scale(1); }
            50% { text-shadow: 0 0 15px #ff0, 0 0 25px #ff00ff, 0 0 40px #ff0; transform: translateY(-3px) scale(1.02); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #ff00ff; transform: translateY(0) scale(1); }
        }
        #creator-text {
            animation: shimmer-glow 2.5s infinite alternate;
            display: inline-block;
            color: #fff; 
            /* Ensure text stands out on the rainbow background */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
        }

        /* Live Date/Time Pulse Glow Animation */
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 5px rgba(255, 255, 255, 0.7), 0 0 10px rgba(255, 100, 100, 0.5); }
            50% { text-shadow: 0 0 15px rgba(255, 255, 255, 1), 0 0 25px rgba(255, 100, 100, 0.8); }
        }
        .live-text {
            animation: pulse-glow 3s infinite alternate;
        }

        /* Card Entrance Animation */
        @keyframes bounce-in {
            0% { transform: scale(0.8) translateY(-50px); opacity: 0; }
            50% { transform: scale(1.05) translateY(10px); opacity: 1; }
            100% { transform: scale(1) translateY(0); }
        }
        .card-enter {
            animation: bounce-in 0.8s ease-out both;
        }

        /* Schedule Transition Animation (Fade Out/In) */
        .fade-out { opacity: 0; transition: opacity 0.3s ease-out; }
        .fade-in { opacity: 1; transition: opacity 0.5s ease-in; }

        /* Subject Item Animation */
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .subject-item {
            animation: slide-up 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        
        /* --- Welcome Screen Animation --- */
        @keyframes welcome-pop {
            0% { opacity: 0; transform: scale(0.5) rotate(-5deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0); }
        }
        .welcome-active {
            animation: welcome-pop 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        
    </style>
</head>
<body class="rainbow-bg">

    <!-- Welcome Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 transition-opacity duration-1000 ease-in-out">
        <!-- UPDATED WELCOME TEXT -->
        <div id="welcome-text" class="text-5xl md:text-7xl font-black text-yellow-400 opacity-0" style="text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);">
            ·ûÅ·üÜ·ûö·üÄ·ûì·ûé·û∂·ûÄ·üí·ûò·üÅ·ûÑ·ûè·ûº·ûÖü•≥
        </div>
    </div>

    <!-- Notification Alert System (New Element) -->
    <!-- Updated for larger size (max-w-md) and bigger content -->
    <div id="notification-box" class="fixed top-4 right-4 z-40 p-4 shadow-2xl rounded-2xl bg-red-600/95 transform translate-x-full transition-all duration-500 ease-out border-4 border-yellow-300 hidden max-w-md">
        <!-- UPDATED SPACE-X-4 to SPACE-x-6 for better spacing with large icon -->
        <div class="flex items-center space-x-6">
            <!-- Notification Image (Larger: w-20 h-20) -->
            <img id="notification-image" 
                src="https://files.catbox.moe/jxpg0v.jpeg" 
                onerror="this.onerror=null;this.src='https://placehold.co/60x60/FF0000/FFFFFF?text=PIC';" 
                class="w-20 h-20 rounded-lg object-cover border-2 border-white shadow-lg flex-shrink-0" 
                alt="Teacher Alert">
            
            <div>
                <!-- Main Alert Text (UPDATED: text-2xl to text-3xl) -->
                <p class="text-white text-3xl font-bold">·ûî·üí·ûö·ûô·üê·ûè·üí·ûì! üßë‚Äçüè´</p>
                <!-- Removed: <p class="text-yellow-300 text-sm font-medium">·ûÇ·üí·ûö·ûº·û¢·û∂·ûÖ Online!</p> -->
            </div>
        </div>
    </div>


    <!-- Main Content Wrapper -->
    <div class="w-full max-w-4xl p-4 md:p-8 pt-10">

        <!-- Schedule Card -->
        <div id="schedule-container" class="card-enter w-full bg-white/90 backdrop-blur-sm shadow-2xl rounded-3xl p-6 md:p-10 text-center border-4 border-white/70">

            <!-- Website Title -->
            <h1 class="text-4xl md:text-6xl font-black mb-4 text-red-600 live-text tracking-wide" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
                ·ûè·û∂·ûö·û∂·ûÑ·ûî·ûÑ·üí·ûö·üÄ·ûì
            </h1>
            
            <!-- Live Date and Time -->
            <div class="mb-8 text-lg md:text-xl font-bold text-gray-800 live-text">
                
                <!-- Day Cycling Controls -->
                <div class="flex items-center justify-center space-x-4">
                    
                    <!-- NEW: Home Button to revert to current day -->
                    <button id="home-btn" class="text-3xl font-extrabold text-red-600 hover:text-red-900 transition duration-300 transform hover:scale-125 focus:outline-none" title="·ûè·üí·ûö·û°·ûî·üã·ûë·üÖ·ûê·üí·ûÑ·üÉ·ûñ·û∑·ûè·ûî·üí·ûö·û∂·ûÄ·ûä">
                        üè† <!-- Home Icon Emoji -->
                    </button>

                    <button id="prev-day-btn" class="text-3xl font-extrabold text-blue-500 hover:text-blue-700 transition duration-300 transform hover:scale-125 focus:outline-none">
                        &#x25C0; <!-- Left Arrow -->
                    </button>
                    <span id="khmer-day" class="text-3xl md:text-4xl font-extrabold text-blue-700 block mb-1">...</span>
                    <button id="next-day-btn" class="text-3xl font-extrabold text-blue-500 hover:text-blue-700 transition duration-300 transform hover:scale-125 focus:outline-none">
                        &#x25B6; <!-- Right Arrow -->
                    </button>
                </div>

                <span id="live-date">...</span> | <span id="live-time">...</span>
            </div>

            <!-- Presence Counters -->
            <div class="flex justify-center items-center space-x-6 mb-6 text-xl">
                <div title="·û¢·üí·ûì·ûÄ·ûÄ·üÜ·ûñ·ûª·ûÑ Online" class="flex items-center space-x-2 text-green-600 font-bold live-text">
                    <span class="text-2xl">‚óè</span>
                    <span id="online-counter">0</span>
                </div>
                <div title="·û¢·üí·ûì·ûÄ·ûÖ·ûº·ûõ·ûò·ûæ·ûõ·ûü·ûö·ûª·ûî" class="flex items-center space-x-2 text-blue-600 font-bold">
                    <span class="text-2xl">‚ñ†</span>
                    <span id="total-counter">0</span>
                </div>
            </div>

            <!-- Schedule Title -->
            <h2 class="text-2xl md:text-3xl font-bold text-green-600 mb-6 border-b-2 pb-2 border-green-300">
                <span class="live-text">TODAY HAVE</span>
            </h2>

            <!-- Schedule List -->
            <div id="schedule-list" class="grid gap-4 text-left">
                <div class="text-gray-500">·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûë·ûª·ûÄ·ûè·û∂·ûö·û∂·ûÑ...</div>
            </div>
            
            <!-- Spacer -->
            <div class="h-20"></div> 

        </div>

        <!-- Creator & Bio Section (Always visible) -->
        <div id="creator-bio-section" class="w-full py-8 mt-4 text-center">
            
            <div id="creator-text-container" class="mb-4 text-center">
                <span id="creator-text" class="text-xl md:text-3xl font-black tracking-widest transition-colors duration-500">
                    Creator by ·ûò·û∂·ûü ·ûî·üä·ûª·ûé·üí·ûé·û∂·ûú·û∏·ûè
                </span>
            </div>

            <div id="bio-text" class="w-full max-w-2xl mx-auto p-6 rounded-2xl shadow-2xl bg-black/70 text-white/90">
                <p class="text-lg md:text-xl font-bold tracking-wide">
                    Thank For Using My Website I Just Show My IQ And This is For G7B2 Only
                </p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Constants ---
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;
        let isAuthReady = false; 
        const USER_ACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes (300000ms)
        
        // Notification timing constants
        const NOTIFICATION_DURATION = 6000; // 6 seconds (UPDATED from 3000)
        const NOTIFICATION_INTERVAL = 360000; // 360 seconds (6 minutes)

        // Global Variables from Canvas Environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const generateAnonId = () => 'anon-' + Math.random().toString(36).substring(2, 9) + Date.now();

        // Key: Day of the week (0=Sunday, 1=Monday, ..., 6=Saturday)
        const SCHEDULE_DATA = {
            1: { dayKh: "·ûê·üí·ûÑ·üÉ·ûÖ·ûì·üí·ûë", classes: [{ subject: "·û¢·ûÑ·üã·ûÇ·üí·ûõ·üÅ·ûü", time: "13:00 > 14:00" }, { subject: "·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "14:00 > 15:00" }, { subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", time: "15:00 > 17:00" }] },
            2: { dayKh: "·ûê·üí·ûÑ·üÉ·û¢·ûÑ·üí·ûÇ·û∂·ûö", classes: [{ subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö", time: "13:00 > 14:00" }, { subject: "·û¢·ûÑ·üã·ûÇ·üí·ûõ·üÅ·ûü", time: "14:00 > 15:00" }, { subject: "·ûï·üÇ·ûì·ûä·û∏·ûú·û∑·ûë·üí·ûô·û∂", time: "15:00 > 16:00" }, { subject: "·ûó·ûº·ûò·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "16:00 > 17:00" }] },
            3: { dayKh: "·ûê·üí·ûÑ·üÉ·ûñ·ûª·ûí", classes: [{ subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", time: "13:00 > 15:00" }, { subject: "·ûÇ·û∏·ûò·û∏·ûú·û∑·ûë·üí·ûô·û∂", time: "15:00 > 16:00" }, { subject: "·ûá·û∏·ûú·ûú·û∑·ûë·üí·ûô·û∂", time: "16:00 > 17:00" }] },
            4: { dayKh: "·ûê·üí·ûÑ·üÉ·ûñ·üí·ûö·û†·ûü·üí·ûî·ûè·û∑·üç", classes: [{ subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö", time: "13:00 > 15:00" }, { subject: "·ûó·ûº·ûò·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "15:00 > 16:00" }, { subject: "·ûá·û∏·ûú·ûú·û∑·ûë·üí·ûô·û∂", time: "16:00 > 17:00" }] },
            5: { dayKh: "·ûê·üí·ûÑ·üÉ·ûü·ûª·ûÄ·üí·ûö", classes: [{ subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö", time: "13:00 > 15:00" }, { subject: "·ûü·û∏·ûõ·ûí·ûò·üå ·ûñ·ûõ·ûö·ûä·üí·ûã", time: "15:00 > 16:00" }, { subject: "·ûö·ûº·ûî·ûú·û∑·ûë·üí·ûô·û∂", time: "16:00 > 17:00" }] },
            6: { dayKh: "·ûê·üí·ûÑ·üÉ·ûü·üÖ·ûö·üç", classes: [{ subject: "·ûó·ûº·ûò·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "13:00 > 14:00" }, { subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", time: "14:00 > 16:00" }] },
            0: { dayKh: "·ûê·üí·ûÑ·üÉ·û¢·û∂·ûë·û∑·ûè·üí·ûô", classes: [{ subject: "·ûö·û∏·ûÄ·ûö·û∂·ûô·ûê·üí·ûÑ·üÉ·ûà·ûî·üã·ûü·ûò·üí·ûö·û∂·ûÄ!", time: "·ûñ·üÅ·ûâ·ûò·ûΩ·ûô·ûê·üí·ûÑ·üÉ" }] }
        };

        // DOM Elements
        const khmerDayEl = document.getElementById('khmer-day');
        const liveDateEl = document.getElementById('live-date');
        const liveTimeEl = document.getElementById('live-time');
        const scheduleListEl = document.getElementById('schedule-list');
        const nextDayBtn = document.getElementById('next-day-btn');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const homeBtn = document.getElementById('home-btn'); 
        const onlineCounterEl = document.getElementById('online-counter');
        const totalCounterEl = document.getElementById('total-counter');
        const notificationBoxEl = document.getElementById('notification-box'); // NEW

        let realDayIndex = null;
        let displayDayIndex = null;
        let overrideTimer = null;


        // --- Utility Functions ---

        function applyTransition(element, contentCallback) {
            if (!element) return;
            element.classList.add('fade-out');

            setTimeout(() => {
                contentCallback();
                element.classList.remove('fade-out');
                element.classList.add('fade-in');
            }, 300);

            setTimeout(() => {
                element.classList.remove('fade-in');
            }, 800);
        }

        function renderScheduleList(classes, animate = true) {
            scheduleListEl.innerHTML = '';
            
            classes.forEach((item, index) => {
                const subjectEl = document.createElement('div');
                subjectEl.className = 'bg-gray-100 p-4 rounded-xl shadow-lg flex justify-between items-center text-gray-800 border-l-8 border-yellow-500 hover:shadow-xl transition duration-300 transform hover:scale-[1.01]';
                
                if (animate) {
                    subjectEl.classList.add('subject-item');
                    subjectEl.style.animationDelay = `${index * 0.1}s`;
                }

                const subjectText = document.createElement('span');
                subjectText.className = 'text-xl md:text-2xl font-bold';
                subjectText.textContent = item.subject;

                const timeText = document.createElement('span');
                timeText.className = 'text-sm md:text-lg font-medium text-red-500 bg-yellow-100 px-3 py-1 rounded-full shadow-inner';
                timeText.textContent = item.time;
                
                subjectEl.appendChild(subjectText);
                subjectEl.appendChild(timeText);
                scheduleListEl.appendChild(subjectEl);
            });
        }
        
        function renderSchedule(dayIndex, animate = true) {
            const todaySchedule = SCHEDULE_DATA[dayIndex];
            
            if (animate) {
                applyTransition(khmerDayEl, () => {
                    khmerDayEl.textContent = todaySchedule.dayKh;
                });
                
                applyTransition(scheduleListEl, () => {
                    renderScheduleList(todaySchedule.classes, true);
                });
            } else {
                khmerDayEl.textContent = todaySchedule.dayKh;
                renderScheduleList(todaySchedule.classes, false);
            }
        }

        function updateLiveTimeAndDay() {
            const now = new Date();
            const timeZone = 'Asia/Phnom_Penh';

            const optionsDate = { year: 'numeric', month: 'long', day: 'numeric', timeZone: timeZone };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: timeZone };

            const fullDate = new Intl.DateTimeFormat('km-KH', optionsDate).format(now);
            const liveTime = new Intl.DateTimeFormat('en-US', optionsTime).format(now);
            
            const newRealDayIndex = now.getDay();

            if (realDayIndex === null || realDayIndex !== newRealDayIndex) {
                realDayIndex = newRealDayIndex;
                
                clearTimeout(overrideTimer);
                if (displayDayIndex === null || displayDayIndex === newRealDayIndex) {
                    displayDayIndex = realDayIndex;
                    renderSchedule(displayDayIndex, true); 
                }
            }

            if (displayDayIndex === null) {
                displayDayIndex = realDayIndex;
                renderSchedule(displayDayIndex, false);
            }
            
            liveDateEl.textContent = fullDate.trim(); 
            liveTimeEl.textContent = liveTime;
            khmerDayEl.textContent = SCHEDULE_DATA[displayDayIndex].dayKh;
        }

        function cycleDay(direction) {
            
            if (overrideTimer === null || displayDayIndex === realDayIndex) {
                displayDayIndex = realDayIndex;
            }

            clearTimeout(overrideTimer);

            let nextIndex = displayDayIndex + direction;

            if (nextIndex > 6) nextIndex = 0;
            if (nextIndex < 0) nextIndex = 6;

            displayDayIndex = nextIndex;
            
            renderSchedule(displayDayIndex, true);

            overrideTimer = setTimeout(() => {
                displayDayIndex = realDayIndex;
                renderSchedule(realDayIndex, true);
                overrideTimer = null;
            }, 20000); // 20 seconds
        }

        function goToRealDay() {
            if (overrideTimer) {
                clearTimeout(overrideTimer);
                overrideTimer = null;
            }
            if (displayDayIndex !== realDayIndex) {
                displayDayIndex = realDayIndex;
                renderSchedule(realDayIndex, true);
            }
        }

        // --- Notification Functions ---

        function showNotification() {
            if (!notificationBoxEl) return;
            
            // 1. Show the box (remove hidden class)
            notificationBoxEl.classList.remove('hidden');
            
            // 2. Slide In (remove the translation class)
            // Use a small delay (10ms) to ensure 'hidden' removal processes before transition
            setTimeout(() => {
                notificationBoxEl.classList.remove('translate-x-full'); 
            }, 10); 

            // 3. Hide after NOTIFICATION_DURATION (6 seconds now)
            setTimeout(() => {
                // Slide Out (add the translation class)
                notificationBoxEl.classList.add('translate-x-full');

                // 4. Hide completely after the slide-out transition finishes (500ms duration from CSS)
                setTimeout(() => {
                    notificationBoxEl.classList.add('hidden');
                }, 500); 
                
            }, NOTIFICATION_DURATION);
        }

        function startNotificationLoop() {
            // Show immediately after welcome
            showNotification(); 

            // Start the loop for every 360 seconds (6 minutes)
            setInterval(showNotification, NOTIFICATION_INTERVAL);
        }

        // --- Welcome Initialization ---

        function initializeWelcome() {
            const overlay = document.getElementById('welcome-overlay');
            const text = document.getElementById('welcome-text');

            text.classList.add('welcome-active');

            setTimeout(() => {
                overlay.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.remove();
                    // Start the notification loop once welcome is gone
                    startNotificationLoop(); 
                }, 1000); // Wait for opacity transition to finish
            }, 3000); // Welcome text display time
        }
        
        // --- Firebase Initialization and Presence Tracking ---

        async function initializeFirebase() {
            // Enable Firestore debug logging (Helpful for diagnosing permission errors)
            setLogLevel('debug'); 

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Attempt Sign In
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom token sign in failed, falling back to anonymous:", e);
                        return signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener (Crucial for getting UID and starting presence tracking)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Fallback for anonymous users
                        userId = generateAnonId(); 
                    }
                    
                    isAuthReady = true;
                    console.log("Auth Ready. User ID:", userId);

                    // Once authenticated, start presence tracking
                    if (db) {
                        trackPresence();
                    } else {
                        console.error("Firestore DB is not initialized.");
                    }
                });
                
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }


        function trackPresence() {
            if (!db || !userId) return;

            console.log("Starting presence tracking for:", userId);

            // Path components for the required public collection structure:
            // /artifacts/{appId}/public/data/{collection_name} (5 segments - Odd)
            const PUBLIC_BASE_PATH = ["artifacts", appId, "public", "data"]; // 4 segments: C/D/C/D

            // --- 1. Real-time Online Status ---
            // Fix: Use 5 segments (C/D/C/D/C) for the collection reference
            const onlinePresenceRef = collection(db, ...PUBLIC_BASE_PATH, "online_status");
            const currentUserOnlineDocRef = doc(onlinePresenceRef, userId);

            // Function to update public online status
            const setOnline = async (isOnline) => {
                try {
                    if (isOnline) {
                        // Set/Update last_seen to show they are currently active
                        await setDoc(currentUserOnlineDocRef, {
                            last_seen: serverTimestamp(),
                            user_id: userId
                        });
                    } else {
                        // When leaving, update last_seen_offline but keep the doc for total count
                        await updateDoc(currentUserOnlineDocRef, {
                            last_seen_offline: serverTimestamp(),
                        }).catch(err => {
                            if (err.code !== 'not-found') {
                                console.warn("Failed to update status on close:", err.message);
                            }
                        }); 
                    }
                } catch (e) {
                    console.error("Failed to update public online status:", e);
                }
            };

            // Update when opening/focusing the window (Heartbeat)
            setOnline(true);
            window.addEventListener('focus', () => setOnline(true));
            // Set heartbeat every 2 minutes to keep status 'fresh'
            setInterval(() => setOnline(true), 2 * 60 * 1000); 

            // Update when closing/leaving the window
            window.addEventListener('beforeunload', () => setOnline(false));


            // --- 2. Total Users (Using a public collection to track unique IDs) ---
            // Fix: Use 6 segments (C/D/C/D/C/D) for the document reference
            const statsDocRef = doc(db, ...PUBLIC_BASE_PATH, "stats", "user_count");
            
            // Update the total unique visitors count field for this user
            const updateStats = async () => {
                try {
                    const updateData = {};
                    // Use the unique user ID as a key in the map to track total users
                    updateData[`total_users.${userId}`] = serverTimestamp();
                    
                    // Try to update/create the document, merging with existing data
                    await setDoc(statsDocRef, updateData, { merge: true });
                } catch (error) {
                    console.error("Error setting/updating total user count:", error);
                }
            };
            updateStats();


            // --- 3. Listen for Online Count (Active within the last 5 minutes) ---
            onSnapshot(onlinePresenceRef, (snapshot) => {
                let onlineCount = 0;
                const cutoff = Date.now() - USER_ACTIVITY_TIMEOUT; 

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastSeenTimestamp = data.last_seen;

                    if (lastSeenTimestamp) {
                        // Convert Firestore Timestamp to JS Date object for comparison
                        const lastSeenTime = lastSeenTimestamp.toDate().getTime();

                        // Check if active in the last 5 minutes (USER_ACTIVITY_TIMEOUT)
                        if (lastSeenTime > cutoff) {
                            onlineCount++;
                        }
                    }
                });
                
                onlineCounterEl.textContent = onlineCount;
                console.log("Online count updated:", onlineCount);
            }, (error) => {
                console.error("Error listening to online presence (Check Security Rules!):", error);
            });

            // --- 4. Listen for TOTAL UNIQUE users ---
            onSnapshot(statsDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // Total users is the count of unique keys in the 'total_users' map
                    const totalUsers = data.total_users ? Object.keys(data.total_users).length : 0;
                    totalCounterEl.textContent = totalUsers;
                    console.log("Total count updated:", totalUsers);
                } else {
                    totalCounterEl.textContent = 1; // If the doc doesn't exist, this user is the first
                    console.log("Total count updated: 1 (initial visitor)");
                }
            }, (error) => {
                console.error("Error listening to total users (Check Security Rules!):", error);
            });
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup day cycling buttons
            nextDayBtn.addEventListener('click', () => cycleDay(1)); // +1 day
            prevDayBtn.addEventListener('click', () => cycleDay(-1)); // -1 day
            
            // Setup Home button
            homeBtn.addEventListener('click', goToRealDay);

            // Run initial update and set interval for time/day
            updateLiveTimeAndDay();
            setInterval(updateLiveTimeAndDay, 1000); 
            
            // Show welcome message
            initializeWelcome();

            // Initialize Firebase and start presence tracking after DOM is ready
            initializeFirebase();
        });

    </script>

</body>
</html>
