<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåå ·ûè·û∂·ûö·û∂·ûÑ·ûî·ûÑ·üí·ûö·üÄ·ûì Space Update</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles for Body (Black Space Background) */
        body {
            font-family: 'Battambang', system-ui, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background-color: #000000; /* Solid black background */
            overflow-x: hidden;
            position: relative;
        }

        /* --- 1. Space Background Animations (Stars & Comet) --- */
        /* Animation for twinkling stars */
        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.5; transform: scale(1); }
        }

        /* Container for stars and comet */
        .space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* Star element styling */
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 5px #fff, 0 0 10px #ff0;
            animation: twinkle 4s ease-in-out infinite alternate;
        }

        /* Comet/Shooting Star Animation */
        @keyframes shoot {
            0% { transform: translate(-100vw, -100vh); opacity: 0; }
            5% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { transform: translate(100vw, 100vh); opacity: 0; }
        }
        .comet {
            position: absolute;
            width: 3px;
            height: 3px;
            background: linear-gradient(to right, rgba(255, 255, 255, 0), #ff8000);
            border-radius: 50%;
            box-shadow: 0 0 10px #ff8000;
            animation: shoot 15s linear infinite;
        }

        /* --- 2. Alien Emoji Animation --- */
        @keyframes float-alien {
            0% { transform: translate(0, 0) rotate(5deg); }
            50% { transform: translate(15px, -15px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(5deg); }
        }
        .alien {
            position: absolute;
            top: 5%;
            left: 5%;
            font-size: 5rem;
            opacity: 0.7;
            animation: float-alien 8s ease-in-out infinite alternate;
            z-index: 1;
        }
        .alien:nth-child(2) {
            top: 80%;
            right: 10%;
            left: auto;
            font-size: 3rem;
            animation-delay: 2s;
        }
        
        /* --- 3. Update Icon Animation --- */
        /* Shaking Icon */
        @keyframes icon-shake {
            0%, 100% { transform: rotate(0deg); }
            20%, 60% { transform: rotate(-10deg); }
            40%, 80% { transform: rotate(10deg); }
        }
        /* Glowing/Pulsing Text */
        @keyframes text-glow {
            0%, 100% { color: #facc15; text-shadow: 0 0 5px #facc15, 0 0 10px #f97316; }
            50% { color: #fee2e2; text-shadow: 0 0 10px #fee2e2, 0 0 20px #dc2626; }
        }
        
        #update-icon-container {
            animation: icon-shake 1.5s infinite alternate;
        }
        #update-text {
            animation: text-glow 2s infinite alternate;
        }
        
        /* --- Other Styles --- */
        
        /* Creator Text Animation (Shimmering Glow) */
        @keyframes shimmer-glow {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #00ffff; transform: translateY(0) scale(1); }
            50% { text-shadow: 0 0 15px #0ff, 0 0 25px #00ffff, 0 0 40px #0ff; transform: translateY(-3px) scale(1.02); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #00ffff; transform: translateY(0) scale(1); }
        }
        #creator-text {
            animation: shimmer-glow 2.5s infinite alternate;
            display: inline-block;
            color: #fff; 
            text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
        }

        /* Live Date/Time Pulse Glow Animation (Adapted for space theme) */
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 5px rgba(100, 255, 255, 0.7), 0 0 10px rgba(0, 255, 0, 0.5); }
            50% { text-shadow: 0 0 15px rgba(100, 255, 255, 1), 0 0 25px rgba(0, 255, 0, 0.8); }
        }
        .live-text {
            animation: pulse-glow 3s infinite alternate;
        }

        /* Card Entrance Animation */
        @keyframes bounce-in {
            0% { transform: scale(0.8) translateY(-50px); opacity: 0; }
            50% { transform: scale(1.05) translateY(10px); opacity: 1; }
            100% { transform: scale(1) translateY(0); }
        }
        .card-enter {
            animation: bounce-in 0.8s ease-out both;
        }

        /* Schedule Transition Animation (Fade Out/In) */
        .fade-out { opacity: 0; transition: opacity 0.3s ease-out; }
        .fade-in { opacity: 1; transition: opacity 0.5s ease-in; }

        /* Subject Item Animation */
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .subject-item {
            animation: slide-up 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        
        /* Welcome Screen Animation */
        @keyframes welcome-pop {
            0% { opacity: 0; transform: scale(0.5) rotate(-5deg); }
            50% { opacity: 1; transform: scale(1.1) rotate(5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0); }
        }
        .welcome-active {
            animation: welcome-pop 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        
    </style>
</head>
<body>
    
    <!-- 1. SPACE BACKGROUND CONTAINER -->
    <div id="space-bg" class="space-bg">
        <!-- Alien 1 -->
        <span class="alien" style="top: 15%; left: 10%; animation-delay: 0s;">üëΩ</span>
        <!-- Alien 2 -->
        <span class="alien" style="top: 75%; right: 5%; left: auto; font-size: 3.5rem; animation-delay: 4s;">üëæ</span>
        <!-- Comet/Shooting Star (Will be created dynamically in JS) -->
    </div>
    
    <!-- Welcome Overlay -->
    <div id="welcome-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 transition-opacity duration-1000 ease-in-out">
        <div id="welcome-text" class="text-5xl md:text-7xl font-black text-yellow-400 opacity-0" style="text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);">
            ·ûÅ·üÜ·ûö·üÄ·ûì·ûé·û∂·ûÄ·üí·ûò·üÅ·ûÑ·ûè·ûº·ûÖü•≥
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="w-full max-w-4xl p-4 md:p-8 pt-10 z-10">

        <!-- Schedule Card -->
        <div id="schedule-container" class="card-enter w-full bg-slate-900/90 backdrop-blur-md shadow-2xl rounded-3xl p-6 md:p-10 text-center border-4 border-cyan-400/50">

            <!-- Website Title -->
            <h1 class="text-4xl md:text-6xl font-black mb-4 text-cyan-400 live-text tracking-wide" style="text-shadow: 0 0 10px rgba(0,255,255,0.5);">
                ·ûè·û∂·ûö·û∂·ûÑ·ûî·ûÑ·üí·ûö·üÄ·ûì
            </h1>
            
            <!-- Live Date and Time -->
            <div class="mb-8 text-lg md:text-xl font-bold text-gray-200 live-text">
                
                <!-- Day Cycling Controls -->
                <div class="flex items-center justify-center space-x-4">
                    
                    <!-- NEW: Home Button to revert to current day -->
                    <button id="home-btn" class="text-3xl font-extrabold text-red-500 hover:text-red-700 transition duration-300 transform hover:scale-125 focus:outline-none" title="·ûè·üí·ûö·û°·ûî·üã·ûë·üÖ·ûê·üí·ûÑ·üÉ·ûñ·û∑·ûè·ûî·üí·ûö·û∂·ûÄ·ûä">
                        üè† <!-- Home Icon Emoji -->
                    </button>

                    <button id="prev-day-btn" class="text-3xl font-extrabold text-blue-400 hover:text-blue-600 transition duration-300 transform hover:scale-125 focus:outline-none">
                        &#x25C0; <!-- Left Arrow -->
                    </button>
                    <span id="khmer-day" class="text-3xl md:text-4xl font-extrabold text-white block mb-1 live-text">...</span>
                    <button id="next-day-btn" class="text-3xl font-extrabold text-blue-400 hover:text-blue-600 transition duration-300 transform hover:scale-125 focus:outline-none">
                        &#x25B6; <!-- Right Arrow -->
                    </button>
                </div>

                <span id="live-date">...</span> | <span id="live-time">...</span>
            </div>

            <!-- Total Visitors Counter (Online counter removed as requested) -->
            <div class="flex justify-center items-center space-x-6 mb-4 text-xl">
                <!-- Total Visitors Counter -->
                <div title="·û¢·üí·ûì·ûÄ·ûÖ·ûº·ûõ·ûò·ûæ·ûõ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã" class="flex items-center space-x-2 text-yellow-400 font-bold live-text">
                    <span class="text-2xl">üë•</span> <!-- People Icon -->
                    <span id="total-counter">54·ûü·û∑·ûü·üí·ûü</span>
                </div>
            </div>

            <!-- User ID Display -->
            <div class="mb-6 text-lg font-bold text-gray-700 bg-cyan-900/50 p-2 rounded-lg shadow-inner border border-cyan-400/30">
                <span class="text-cyan-400">Account ID:</span> <span id="display-user-id" class="text-yellow-400 font-extrabold">...</span>
            </div>
            
            <!-- UPDATE ICON AND TEXT (NEW FEATURE) -->
            <div id="update-icon-container" class="flex items-center justify-center space-x-2 mb-6">
                <span class="text-4xl">üöÄ</span> <!-- Rocket Icon for Update -->
                <span id="update-text" class="text-3xl md:text-4xl font-black tracking-wider">
                    UPDATE!
                </span>
            </div>


            <!-- Schedule Title -->
            <h2 class="text-2xl md:text-3xl font-bold text-green-500 mb-6 border-b-2 pb-2 border-green-500/50">
                <span class="live-text">TODAY HAVE</span>
            </h2>

            <!-- Schedule List -->
            <div id="schedule-list" class="grid gap-4 text-left">
                <div class="text-gray-400">·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûë·ûª·ûÄ·ûè·û∂·ûö·û∂·ûÑ...</div>
            </div>
            
            <!-- Spacer -->
            <div class="h-20"></div> 

        </div>

        <!-- Creator & Bio Section (Always visible) -->
        <div id="creator-bio-section" class="w-full py-8 mt-4 text-center z-10">
            
            <div id="creator-text-container" class="mb-4 text-center">
                <span id="creator-text" class="text-xl md:text-3xl font-black tracking-widest transition-colors duration-500">
                    Creator by ·ûò·û∂·ûü ·ûî·üä·ûª·ûé·üí·ûé·û∂·ûú·û∏·ûè
                </span>
            </div>

            <div id="bio-text" class="w-full max-w-2xl mx-auto p-6 rounded-2xl shadow-2xl bg-black/70 text-cyan-400/90 border border-cyan-400/50">
                <p class="text-lg md:text-xl font-bold tracking-wide">
                    Thank For Using My Website I Just Show My IQ And This is For G7B2 Only
                </p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, updateDoc, setLogLevel, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Constants ---
        let app = null;
        let auth = null;
        let db = null;
        let userId = null; // The unique ID used in Firestore 
        let displayUserId = null; // The short, formatted ID shown to the user
        let isAuthReady = false; 
        
        // Global Variables from Canvas Environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- CUSTOM ID GENERATION ---
        const generateAnonId = () => 'anon-' + Math.random().toString(36).substring(2, 9) + Date.now();
        
        // Function to create the formatted display ID (ID926XXXX)
        function formatDisplayId(uniqueId) {
            const uniquePart = uniqueId.slice(-4).toUpperCase();
            return `ID926${uniquePart}`;
        }
        // --- END CUSTOM ID GENERATION ---


        // Key: Day of the week (0=Sunday, 1=Monday, ..., 6=Saturday)
        const SCHEDULE_DATA = {
            1: { dayKh: "·ûê·üí·ûÑ·üÉ·ûÖ·ûì·üí·ûë", classes: [{ subject: "·û¢·ûÑ·üã·ûÇ·üí·ûõ·üÅ·ûü", time: "07:00 > 08:00" }, { subject: "·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "08:00 > 09:00" }, { subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", time: "09:00 > 11:00" }] },
            2: { dayKh: "·ûê·üí·ûÑ·üÉ·û¢·ûÑ·üí·ûÇ·û∂·ûö", classes: [{ subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö", time: "07:00 > 08:00" }, { subject: "·ûÖ·û∑·ûì", time: "08:00 > 09:00" }, { subject: "·ûï·üÇ·ûì·ûä·û∏·ûú·û∑·ûë·üí·ûô·û∂", time: "09:00 > 10:00" }, { subject: "·ûó·ûº·ûò·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "10:00 > 11:00" }, { subject: "·ûÄ·ûü·û∑·ûÄ·ûò·üí·ûò", time: "14:00 > 16:00" }] },
            // Corrected day 3 structure by ensuring it's an array of class objects
            3: { dayKh: "·ûê·üí·ûÑ·üÉ·ûñ·ûª·ûí", classes: [{ subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", time: "07:00 > 09:00" }, { subject: "·ûÇ·û∏·ûò·û∏·ûú·û∑·ûë·üí·ûô·û∂", time: "09:00 > 10:00" }, { subject: "·ûá·û∏·ûú·ûú·û∑·ûë·üí·ûô·û∂", time: "10:00 > 11:00" }, { subject: "·ûü·û∑·ûõ·üí·ûî·üá", time: "14:00 > 15:00" }, { subject: "·û¢·ûî·üã·ûö·üÜ·ûÄ·û∂·ûô·ûÄ·û∏·û°·û∂", time: "15:00 > 17:00" }] },
            // Corrected day 4 structure
            4: { dayKh: "·ûê·üí·ûÑ·üÉ·ûñ·üí·ûö·û†·ûü·üí·ûî·ûè·û∑·üç", classes: [{ subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö", time: "07:00 > 08:00" }, { subject: "·ûá·û∏·ûú·ûú·û∑·ûë·üí·ûô·û∂", time: "10:00 > 11:00" }, { subject: "·ûî·ûé·üí·ûé·û∂·ûõ·üê·ûô", time: "13:00 > 14:00" }, { subject: "·ûÇ·üÅ·û†·ûú·û∑·ûë·üí·ûô·û∂", time: "15:00 > 17:00" }] },
            5: { dayKh: "·ûê·üí·ûÑ·üÉ·ûü·ûª·ûÄ·üí·ûö", classes: [{ subject: "·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö", time: "07:00 > 09:00" }, { subject: "·ûü·û∏·ûõ·ûí·ûò·üå ·ûñ·ûõ·ûö·ûä·üí·ûã", time: "09:00 > 10:00" }, { subject: "·ûö·ûº·ûî·ûú·û∑·ûë·üí·ûô·û∂", time: "10:00 > 11:00" }] },
            // Corrected day 6 structure
            6: { dayKh: "·ûê·üí·ûÑ·üÉ·ûü·üÖ·ûö·üç", classes: [{ subject: "·ûó·ûº·ûò·û∑·ûú·û∑·ûë·üí·ûô·û∂", time: "07:00 > 08:00" }, { subject: "·ûÇ·ûé·û∑·ûè·ûú·û∑·ûë·üí·ûô·û∂", time: "08:00 > 10:00" }, { subject: "·û¢·ûÑ·üã·ûÇ·üí·ûõ·üÅ·ûü", time: "10:00 > 11:00" }, { subject: "·ûó·û∂·ûü·û∂·ûî·û∂·ûö·û∂·üÜ·ûÑ", time: "13:00 > 15:00" }] },
            0: { dayKh: "·ûê·üí·ûÑ·üÉ·û¢·û∂·ûë·û∑·ûè·üí·ûô", classes: [{ subject: "·ûö·û∏·ûÄ·ûö·û∂·ûô·ûê·üí·ûÑ·üÉ·ûà·ûî·üã·ûü·ûò·üí·ûö·û∂·ûÄ! üò¥", time: "·ûñ·üÅ·ûâ·ûò·ûΩ·ûô·ûê·üí·ûÑ·üÉ" }] }
        };

        // DOM Elements
        const khmerDayEl = document.getElementById('khmer-day');
        const liveDateEl = document.getElementById('live-date');
        const liveTimeEl = document.getElementById('live-time');
        const scheduleListEl = document.getElementById('schedule-list');
        const nextDayBtn = document.getElementById('next-day-btn');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const homeBtn = document.getElementById('home-btn'); 
        // const onlineCounterEl = document.getElementById('online-counter'); // Removed as requested
        const totalCounterEl = document.getElementById('total-counter');
        const displayUserIdEl = document.getElementById('display-user-id');
        const spaceBgEl = document.getElementById('space-bg');


        let realDayIndex = null;
        let displayDayIndex = null;
        let overrideTimer = null;


        // --- Space Background Functions ---

        function createStar(delay) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.top = `${Math.random() * 100}vh`;
            star.style.left = `${Math.random() * 100}vw`;
            star.style.animationDelay = `${Math.random() * 4 + delay}s`;
            star.style.width = `${Math.random() * 2 + 1}px`;
            star.style.height = star.style.width;
            return star;
        }

        function createComet() {
            const comet = document.createElement('div');
            comet.className = 'comet';
            // Start the comet slightly off-screen top-left
            comet.style.top = `${Math.random() * 20 - 10}vh`;
            comet.style.left = `${Math.random() * 20 - 10}vw`;
            comet.style.animationDelay = `${Math.random() * 20}s`; // Stagger the comet animations
            comet.style.animationDuration = `${Math.random() * 10 + 10}s`; // Vary speed
            return comet;
        }

        function initializeSpaceBackground() {
            // Create 100 stars
            for (let i = 0; i < 100; i++) {
                spaceBgEl.appendChild(createStar(i * 0.05));
            }
            // Create 3 comets
            for (let i = 0; i < 3; i++) {
                spaceBgEl.appendChild(createComet());
            }
        }


        // --- Utility Functions ---

        function applyTransition(element, contentCallback) {
            if (!element) return;
            element.classList.add('fade-out');

            setTimeout(() => {
                contentCallback();
                element.classList.remove('fade-out');
                element.classList.add('fade-in');
            }, 300);

            setTimeout(() => {
                element.classList.remove('fade-in');
            }, 800);
        }

        function renderScheduleList(classes, animate = true) {
            scheduleListEl.innerHTML = '';
            
            classes.forEach((item, index) => {
                const subjectEl = document.createElement('div');
                // Updated styling for space theme
                subjectEl.className = 'bg-cyan-900/40 p-4 rounded-xl shadow-lg flex justify-between items-center text-gray-100 border-l-4 border-yellow-400 hover:shadow-cyan-500/50 transition duration-300 transform hover:scale-[1.01]';
                
                if (animate) {
                    subjectEl.classList.add('subject-item');
                    subjectEl.style.animationDelay = `${index * 0.1}s`;
                }

                const subjectText = document.createElement('span');
                subjectText.className = 'text-xl md:text-2xl font-bold';
                subjectText.textContent = item.subject;

                const timeText = document.createElement('span');
                // Updated time block styling
                timeText.className = 'text-sm md:text-lg font-medium text-red-400 bg-yellow-400/20 px-3 py-1 rounded-full shadow-inner border border-yellow-400';
                timeText.textContent = item.time;
                
                subjectEl.appendChild(subjectText);
                subjectEl.appendChild(timeText);
                scheduleListEl.appendChild(subjectEl);
            });
        }
        
        function renderSchedule(dayIndex, animate = true) {
            const todaySchedule = SCHEDULE_DATA[dayIndex];
            
            if (animate) {
                applyTransition(khmerDayEl, () => {
                    khmerDayEl.textContent = todaySchedule.dayKh;
                });
                
                applyTransition(scheduleListEl, () => {
                    renderScheduleList(todaySchedule.classes, true);
                });
            } else {
                khmerDayEl.textContent = todaySchedule.dayKh;
                renderScheduleList(todaySchedule.classes, false);
            }
        }

        function updateLiveTimeAndDay() {
            const now = new Date();
            const timeZone = 'Asia/Phnom_Penh';

            const optionsDate = { year: 'numeric', month: 'long', day: 'numeric', timeZone: timeZone };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: timeZone };

            const fullDate = new Intl.DateTimeFormat('km-KH', optionsDate).format(now);
            const liveTime = new Intl.DateTimeFormat('en-US', optionsTime).format(now);
            
            const newRealDayIndex = now.getDay();

            if (realDayIndex === null || realDayIndex !== newRealDayIndex) {
                realDayIndex = newRealDayIndex;
                
                clearTimeout(overrideTimer);
                if (displayDayIndex === null || displayDayIndex === newRealDayIndex) {
                    displayDayIndex = realDayIndex;
                    renderSchedule(displayDayIndex, true); 
                }
            }

            if (displayDayIndex === null) {
                displayDayIndex = realDayIndex;
                renderSchedule(displayDayIndex, false);
            }
            
            liveDateEl.textContent = fullDate.trim(); 
            liveTimeEl.textContent = liveTime;
            khmerDayEl.textContent = SCHEDULE_DATA[displayDayIndex].dayKh;
        }

        function cycleDay(direction) {
            
            if (overrideTimer === null || displayDayIndex === realDayIndex) {
                displayDayIndex = realDayIndex;
            }

            clearTimeout(overrideTimer);

            let nextIndex = displayDayIndex + direction;

            if (nextIndex > 6) nextIndex = 0;
            if (nextIndex < 0) nextIndex = 6;

            displayDayIndex = nextIndex;
            
            renderSchedule(displayDayIndex, true);

            overrideTimer = setTimeout(() => {
                displayDayIndex = realDayIndex;
                renderSchedule(realDayIndex, true);
                overrideTimer = null;
            }, 20000); // 20 seconds
        }

        function goToRealDay() {
            if (overrideTimer) {
                clearTimeout(overrideTimer);
                overrideTimer = null;
            }
            if (displayDayIndex !== realDayIndex) {
                displayDayIndex = realDayIndex;
                renderSchedule(realDayIndex, true);
            }
        }
        
        // --- Welcome Initialization ---

        function initializeWelcome() {
            const overlay = document.getElementById('welcome-overlay');
            const text = document.getElementById('welcome-text');

            text.classList.add('welcome-active');

            setTimeout(() => {
                overlay.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.remove();
                }, 1000); // Wait for opacity transition to finish
            }, 3000); // Welcome text display time
        }
        
        // --- Firebase Initialization and Presence Tracking ---

        async function initializeFirebase() {
            setLogLevel('debug'); 

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Attempt Sign In
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom token sign in failed, falling back to anonymous:", e);
                        return signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener 
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = generateAnonId(); 
                    }
                    
                    displayUserId = formatDisplayId(userId);
                    displayUserIdEl.textContent = displayUserId;

                    isAuthReady = true;
                    console.log("Auth Ready. User ID:", userId, "Display ID:", displayUserId);

                    if (db) {
                        trackPresence();
                    } else {
                        console.error("Firestore DB is not initialized. Cannot track presence.");
                    }
                });
                
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }


        function trackPresence() {
            if (!db || !userId) return;

            console.log("Starting presence tracking for:", userId);

            // Path components for the required public collection structure:
            const PUBLIC_BASE_PATH = ["artifacts", appId, "public", "data"]; // C/D/C/D

            // --- 1. Real-time Online Status (Still needed for the total count heartbeat) ---
            const onlinePresenceRef = collection(db, ...PUBLIC_BASE_PATH, "online_status");
            const currentUserOnlineDocRef = doc(onlinePresenceRef, userId);

            // Function to update public online status
            const setOnline = async (isOnline) => {
                try {
                    if (isOnline) {
                        await setDoc(currentUserOnlineDocRef, {
                            last_seen: serverTimestamp(),
                            user_id: userId,
                            display_id: displayUserId
                        });
                    } else {
                        await updateDoc(currentUserOnlineDocRef, {
                            last_seen_offline: serverTimestamp(),
                        }).catch(err => {
                            if (err.code !== 'not-found') {
                                console.warn("Failed to update status on close:", err.message);
                            }
                        }); 
                    }
                } catch (e) {
                    console.error("Failed to update public online status:", e);
                }
            };

            // Heartbeat
            setOnline(true);
            window.addEventListener('focus', () => setOnline(true));
            setInterval(() => setOnline(true), 2 * 60 * 1000); 
            window.addEventListener('beforeunload', () => setOnline(false));


            // --- 2. Total Users ---
            const statsDocRef = doc(db, ...PUBLIC_BASE_PATH, "stats", "user_count");
            
            // Update the total unique visitors count field for this user
            const updateStats = async () => {
                try {
                    const updateData = {};
                    updateData[`total_users.${userId}`] = serverTimestamp();
                    await setDoc(statsDocRef, updateData, { merge: true });
                } catch (error) {
                    console.error("Error setting/updating total user count:", error);
                }
            };
            updateStats();


            // --- 3. Listen for TOTAL UNIQUE users (Online counter removed) ---
            onSnapshot(statsDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    const totalUsers = data.total_users ? Object.keys(data.total_users).length : 0;
                    totalCounterEl.textContent = totalUsers;
                    console.log("Total count updated:", totalUsers);
                } else {
                    totalCounterEl.textContent = 1; 
                    console.log("Total count updated: 1 (initial visitor)");
                }
            }, (error) => {
                console.error("Error listening to total users (Check Security Rules!):", error);
            });
            
            // NOTE: The 'online_status' collection is still updated by the heartbeat, but we stop listening 
            // to it here and removed the display element (onlineCounterEl) as requested.
        }

        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup space background first
            initializeSpaceBackground();
            
            // Setup day cycling buttons
            nextDayBtn.addEventListener('click', () => cycleDay(1)); // +1 day
            prevDayBtn.addEventListener('click', () => cycleDay(-1)); // -1 day
            
            // Setup Home button
            homeBtn.addEventListener('click', goToRealDay);

            // Run initial update and set interval for time/day
            updateLiveTimeAndDay();
            setInterval(updateLiveTimeAndDay, 1000); 
            
            // Show welcome message
            initializeWelcome();

            // Initialize Firebase and start presence tracking after DOM is ready
            initializeFirebase();
        });

    </script>

</body>
</html>
